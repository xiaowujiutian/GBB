# PostgreSQL 数据库连接配置详细操作步骤

## 1. 检查 PostgreSQL 安装与运行状态

首先确认 PostgreSQL 服务是否正常运行：

```bash
sudo systemctl status postgresql
```

如果未运行，启动服务：

```bash
sudo systemctl start postgresql
```

## 2. 创建数据库和用户

登录 PostgreSQL：

```bash
sudo -u postgres psql
```

在 PostgreSQL 控制台中创建数据库和设置密码：

```sql
CREATE DATABASE baby_photo_db;
ALTER USER postgres WITH PASSWORD 'password';
```

> 注意：生产环境请使用强密码，不要使用示例中的 'password'

## 3. 配置环境变量

编辑 .env 文件，确保只保留一个正确的 `DATABASE_URL` 配置：

```bash
# 打开 .env 文件
nano /home/liyong/gbb/server/baby-photo-backend/.env
```

删除或注释掉 `prisma+postgres://` 开头的那行，只保留标准 PostgreSQL 连接字符串：

```properties
# 注释掉不需要的连接字符串
# DATABASE_URL="prisma+postgres://localhost:51213/?api_key=..."

# 保留这个标准连接字符串
DATABASE_URL="postgresql://postgres:password@localhost:5432/baby_photo_db?schema=public"
```

## 4. 连接字符串格式说明

标准 PostgreSQL 连接字符串格式为：
```
postgresql://用户名:密码@主机:端口/数据库名?参数=值
```

- **用户名**: `postgres`（默认超级用户）
- **密码**: `password`（您设置的密码）
- **主机**: `localhost`（本地开发时）
- **端口**: `5432`（PostgreSQL 默认端口）
- **数据库名**: `baby_photo_db`（您创建的数据库）

## 5. 测试数据库连接
##### 1.使用 Prisma 迁移命令创建数据库表结构
###### 在 baby-photo-backend 目录下执行
npx prisma migrate dev --name init
这将会：

基于您的 schema.prisma 文件创建迁移文件
将所有模型结构（User、Package、TimeSlot、Order、Payment）转换为 SQL 表
在数据库中创建这些表
创建迁移历史记录
###### 2.或者使用快速推送命令（适用于开发环境）
npx prisma db push
此命令会直接将模型推送到数据库，但不会创建迁移历史记录。

##### 3.完成后生成 Prisma 客户端
npx prisma generate


执行 Prisma 命令验证连接是否有效：

```bash
cd /home/liyong/gbb/server/baby-photo-backend
npx prisma db pull
```

如果连接正常，应该能够从数据库中拉取模式信息（如果有）。

区别说明:

prisma db pull：从已有数据库结构生成 Prisma 模型（您的数据库是空的，所以失败）
prisma db push：将 Prisma 模型结构推送到数据库（适合开发阶段）

prisma migrate dev：创建迁移记录并应用（推荐方式，便于后续跟踪变更）

对于新项目启动阶段，建议使用 migrate dev 命令，这样可以建立完整的迁移历史，便于后续的团队协作和版本控制。
## 6. 生成 Prisma 客户端
/home/liyong/gbb/server/baby-photo-backend/.env里面的内容正确启动数据库

DATABASE_URL="postgresql://postgres:postgres@localhost:5432/baby_photo_db?schema=public"
确保连接正常后，生成 Prisma 客户端代码：

```bash
npx prisma generate
```
注意：使用pnpm时的路径问题，nestjs和pnpm指向的prisma客户端的路径不同，需要修改1、package.json 里面包括
"scripts": {
 "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio",
},
2、tsconfig.json里面的prisma客户端文件路径：

  "paths": {
      "@prisma/client": [
        "./node_modules/@prisma/client/index"
      ]
    },

3、gitignore文件里面添加

/generated/
/node_modules/.prisma

4、修改文件/home/liyong/gbb/server/baby-photo-backend/prisma/schema.prisma内容为：

generator client {
  provider = "prisma-client-js"   
}

5、修复的命令：
根据完整的安装日志，现在需要执行关键的后置操作来确保Prisma客户端正确生成。以下是分步解决方案：

关键修复步骤

1. **批准Prisma构建脚本**（必须执行）
```bash
pnpm approve-builds @prisma/client
# 出现提示时输入 y 确认
```

2. **强制重新生成客户端**
```bash
rm -rf node_modules/.prisma
npx prisma generate
```

3. **验证客户端位置**
```bash
# 检查标准路径
ls -l node_modules/@prisma/client

# 检查PNPM实际路径
ls -l node_modules/.pnpm/@prisma+client@*/node_modules/@prisma/client
```

4. **配置TypeScript路径映射**
```bash
echo '{
  "compilerOptions": {
    "paths": {
      "@prisma/client": ["./node_modules/@prisma/client/index"]
    }
  }
}' > tsconfig.json
```

验证流程

1. **检查生成结果**
```bash
# 应该看到以下文件
ls -l node_modules/@prisma/client/index.d.ts
ls -l node_modules/@prisma/client/runtime/
```

2. **测试类型解析**
```typescript
// 创建测试文件 test-prisma.ts
import { PrismaClient } from '@prisma/client';
console.log(new PrismaClient().$extends);
```

3. **执行测试**
```bash
npx ts-node test-prisma.ts
# 应该正常输出 [Function: $extends]
```

 永久配置建议

1. **更新.npmrc**
```bash
echo "auto-install-peers=true" >> .npmrc
echo "prefer-symlinked-executables=true" >> .npmrc
```

2. **添加postinstall钩子**
```bash
# 在package.json中添加
"scripts": {
  "postinstall": "npx prisma generate"
}
```

 常见问题处理

如果仍然报错，尝试：
```bash
# 完全清理重建
rm -rf node_modules pnpm-lock.yaml .npmrc
pnpm install
npx prisma generate
```

现在你的环境应该已经正确配置，所有类型错误应该消失。关键点是确保：
1. Prisma构建脚本被批准执行
2. 客户端生成在标准路径
3. TypeScript能正确解析类型定义


## 7. 应用数据库迁移（如果有）

如果您已经定义了 Prisma 模型，可以应用迁移：

```bash
# 创建迁移
npx prisma migrate dev --name init

# 或直接推送架构（开发环境）
npx prisma db push
```

## 8. 常见问题解决

- **连接错误**：检查 PostgreSQL 服务是否运行，以及用户名/密码是否正确
- **权限问题**：确保 PostgreSQL 用户有适当的权限
- **数据库不存在**：确认已创建数据库 `baby_photo_db`

使用以上步骤，您就能成功配置并使用指定的数据库连接字符串了。