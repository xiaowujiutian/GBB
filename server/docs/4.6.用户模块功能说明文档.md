# ğŸ‘¤ ç”¨æˆ·æ¨¡å—åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## ç›®å½•
- [æ¨¡å—æ¦‚è¿°](#æ¨¡å—æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [API æ¥å£è¯¦æƒ…](#api-æ¥å£è¯¦æƒ…)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [ä¸šåŠ¡é€»è¾‘](#ä¸šåŠ¡é€»è¾‘)
- [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [å®‰å…¨ç‰¹æ€§](#å®‰å…¨ç‰¹æ€§)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¨¡å—æ¦‚è¿°

### ğŸ¯ åŠŸèƒ½å®šä½
ç”¨æˆ·æ¨¡å—æ˜¯å©´å„¿æ‘„å½±å·¥ä½œå®¤ç³»ç»Ÿçš„åŸºç¡€æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚è¯¥æ¨¡å—ä¸»è¦å¤„ç†å¾®ä¿¡å°ç¨‹åºç”¨æˆ·çš„æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºæ•´ä¸ªé¢„çº¦ç³»ç»Ÿæä¾›ç”¨æˆ·èº«ä»½è®¤è¯å’ŒåŸºç¡€æ•°æ®æ”¯æŒã€‚

### ğŸš€ ä¸»è¦ç‰¹æ€§
- **å¾®ä¿¡é›†æˆ**: æ”¯æŒå¾®ä¿¡å°ç¨‹åºç”¨æˆ·openidè®¤è¯
- **å®Œæ•´çš„ç”¨æˆ·ç®¡ç†**: åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ç”¨æˆ·ä¿¡æ¯
- **çµæ´»çš„æ•°æ®ç»“æ„**: æ”¯æŒå¯é€‰å­—æ®µï¼Œé€‚åº”ä¸åŒåœºæ™¯éœ€æ±‚
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰å’ŒéªŒè¯
- **RESTful API**: æ ‡å‡†çš„RESTæ¥å£è®¾è®¡
- **Swaggeræ–‡æ¡£**: å®Œæ•´çš„APIæ–‡æ¡£æ”¯æŒ

### ğŸ“Š ä¸šåŠ¡ä»·å€¼
- ç»Ÿä¸€ç”¨æˆ·èº«ä»½ç®¡ç†ï¼Œæ”¯æŒå¾®ä¿¡ç”Ÿæ€é›†æˆ
- æä¾›ç”¨æˆ·ç”»åƒåŸºç¡€æ•°æ®æ”¯æŒ
- æ”¯æŒä¸ªæ€§åŒ–æœåŠ¡å’Œå®¢æˆ·å…³ç³»ç®¡ç†
- ä¸ºè®¢å•å’Œæ”¯ä»˜æä¾›ç”¨æˆ·å…³è”åŸºç¡€
- ä¾¿äºç”¨æˆ·è¡Œä¸ºåˆ†æå’Œä¸šåŠ¡ä¼˜åŒ–

---

## ç³»ç»Ÿæ¶æ„

### ğŸ—ï¸ æ¨¡å—ç»“æ„
```
src/modules/users/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-user.dto.ts     # åˆ›å»ºç”¨æˆ·DTO
â”‚   â””â”€â”€ update-user.dto.ts     # æ›´æ–°ç”¨æˆ·DTO
â”œâ”€â”€ users.controller.ts        # ç”¨æˆ·æ§åˆ¶å™¨
â”œâ”€â”€ users.service.ts           # ç”¨æˆ·æœåŠ¡
â””â”€â”€ users.module.ts            # ç”¨æˆ·æ¨¡å—
```

### ğŸ”„ æ¶æ„å±‚æ¬¡
1. **æ§åˆ¶å™¨å±‚**: å¤„ç†HTTPè¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œå“åº”æ ¼å¼åŒ–
2. **æœåŠ¡å±‚**: ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ•°æ®éªŒè¯ï¼Œå¼‚å¸¸å¤„ç†
3. **æ•°æ®è®¿é—®å±‚**: é€šè¿‡Prismaè¿›è¡Œæ•°æ®åº“æ“ä½œ
4. **DTOå±‚**: æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œç¡®ä¿ç±»å‹å®‰å…¨å’ŒéªŒè¯

### ğŸ”— ä¾èµ–å…³ç³»
- **PrismaModule**: æ•°æ®åº“è®¿é—®æœåŠ¡
- **class-validator**: æ•°æ®éªŒè¯åº“
- **@nestjs/swagger**: APIæ–‡æ¡£ç”Ÿæˆ
- **@nestjs/common**: NestJSæ ¸å¿ƒè£…é¥°å™¨

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·åˆ›å»º
**åŠŸèƒ½æè¿°**: åˆ›å»ºæ–°ç”¨æˆ·è®°å½•ï¼Œä¸»è¦ç”¨äºå¾®ä¿¡ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶
- å¿…å¡«å­—æ®µéªŒè¯ï¼ˆopenidï¼‰
- å¯é€‰å­—æ®µå¤„ç†ï¼ˆnickname, avatar, phoneï¼‰
- æ•°æ®åº“å”¯ä¸€æ€§çº¦æŸæ£€æŸ¥
- å¼‚å¸¸å¤„ç†å’Œé”™è¯¯è¿”å›

### 2. ç”¨æˆ·æŸ¥è¯¢
**å•ä¸ªæŸ¥è¯¢**: æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
**æ‰¹é‡æŸ¥è¯¢**: è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼Œæ”¯æŒç®¡ç†åå°ä½¿ç”¨
**å…³è”æŸ¥è¯¢**: å¯æ‰©å±•æ”¯æŒæŸ¥è¯¢ç”¨æˆ·çš„è®¢å•å†å²ç­‰å…³è”æ•°æ®

### 3. ç”¨æˆ·æ›´æ–°
**éƒ¨åˆ†æ›´æ–°**: æ”¯æŒæ›´æ–°ç”¨æˆ·çš„éƒ¨åˆ†å­—æ®µ
**å­—æ®µéªŒè¯**: æ›´æ–°æ—¶è¿›è¡Œæ•°æ®æ ¼å¼éªŒè¯
**å­˜åœ¨æ€§æ£€æŸ¥**: ç¡®ä¿æ›´æ–°çš„ç”¨æˆ·å­˜åœ¨

### 4. ç”¨æˆ·åˆ é™¤
**è½¯åˆ é™¤æ”¯æŒ**: å¯æ‰©å±•å®ç°è½¯åˆ é™¤åŠŸèƒ½
**å…³è”æ£€æŸ¥**: åˆ é™¤å‰æ£€æŸ¥æ˜¯å¦æœ‰å…³è”è®¢å•ç­‰æ•°æ®
**æ•°æ®å®Œæ•´æ€§**: ç¡®ä¿åˆ é™¤ä¸å½±å“ç³»ç»Ÿæ•°æ®å®Œæ•´æ€§

---

## API æ¥å£è¯¦æƒ…

### ğŸ“‹ æ¥å£åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ç  |
|------|------|------|--------|
| POST | `/users` | åˆ›å»ºç”¨æˆ· | 201, 400 |
| GET | `/users` | è·å–æ‰€æœ‰ç”¨æˆ· | 200, 500 |
| GET | `/users/:id` | è·å–ç”¨æˆ·è¯¦æƒ… | 200, 404 |
| PATCH | `/users/:id` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | 200, 400, 404 |
| DELETE | `/users/:id` | åˆ é™¤ç”¨æˆ· | 200, 404, 409 |

### ğŸ” æ¥å£è¯¦ç»†è¯´æ˜

#### 1. åˆ›å»ºç”¨æˆ·
```http
POST /users
Content-Type: application/json

{
  "openid": "wx_openid_123456789",
  "nickname": "å°å®è´å¦ˆå¦ˆ",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13800138000"
}
```

**è¯·æ±‚å‚æ•°**:
- `openid` (å¿…å¡«): å¾®ä¿¡ç”¨æˆ·çš„openid
- `nickname` (å¯é€‰): ç”¨æˆ·æ˜µç§°
- `avatar` (å¯é€‰): ç”¨æˆ·å¤´åƒURL
- `phone` (å¯é€‰): ç”¨æˆ·æ‰‹æœºå·

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "openid": "wx_openid_123456789",
  "nickname": "å°å®è´å¦ˆå¦ˆ",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13800138000",
  "createdAt": "2024-07-25T10:30:00.000Z",
  "updatedAt": "2024-07-25T10:30:00.000Z"
}
```

#### 2. è·å–æ‰€æœ‰ç”¨æˆ·
```http
GET /users
```

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "id": 1,
    "openid": "wx_openid_123456789",
    "nickname": "å°å®è´å¦ˆå¦ˆ",
    "avatar": "https://example.com/avatar.jpg",
    "phone": "13800138000",
    "createdAt": "2024-07-25T10:30:00.000Z",
    "updatedAt": "2024-07-25T10:30:00.000Z"
  }
]
```

#### 3. è·å–ç”¨æˆ·è¯¦æƒ…
```http
GET /users/1
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "openid": "wx_openid_123456789",
  "nickname": "å°å®è´å¦ˆå¦ˆ",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13800138000",
  "createdAt": "2024-07-25T10:30:00.000Z",
  "updatedAt": "2024-07-25T10:30:00.000Z"
}
```

#### 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
```http
PATCH /users/1
Content-Type: application/json

{
  "nickname": "æ›´æ–°çš„æ˜µç§°",
  "phone": "13900139000"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "openid": "wx_openid_123456789",
  "nickname": "æ›´æ–°çš„æ˜µç§°",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13900139000",
  "createdAt": "2024-07-25T10:30:00.000Z",
  "updatedAt": "2024-07-25T11:00:00.000Z"
}
```

---

## æ•°æ®æ¨¡å‹

### ğŸ“Š ç”¨æˆ·æ•°æ®ç»“æ„
```typescript
interface User {
  id: number;          // ä¸»é”®ID
  openid: string;      // å¾®ä¿¡openid (å”¯ä¸€)
  nickname?: string;   // ç”¨æˆ·æ˜µç§° (å¯é€‰)
  avatar?: string;     // å¤´åƒURL (å¯é€‰)
  phone?: string;      // æ‰‹æœºå· (å¯é€‰)
  createdAt: Date;     // åˆ›å»ºæ—¶é—´
  updatedAt: Date;     // æ›´æ–°æ—¶é—´
  
  // å…³è”å…³ç³»
  orders?: Order[];    // ç”¨æˆ·çš„è®¢å•åˆ—è¡¨
}
```

### ğŸ”— å…³è”å…³ç³»
- **ä¸€å¯¹å¤š**: User â†’ Order (ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢å•)
- **ä¸€å¯¹å¤š**: User â†’ Payment (é€šè¿‡è®¢å•å…³è”æ”¯ä»˜è®°å½•)
- **ä¸€å¯¹å¤š**: User â†’ TimeSlot (é€šè¿‡è®¢å•å…³è”æ—¶é—´æ§½)

### ğŸ“ DTO ç»“æ„

#### CreateUserDto
```typescript
{
  openid: string;      // å¿…å¡«ï¼Œå¾®ä¿¡openid
  nickname?: string;   // å¯é€‰ï¼Œç”¨æˆ·æ˜µç§°
  avatar?: string;     // å¯é€‰ï¼Œå¤´åƒURL
  phone?: string;      // å¯é€‰ï¼Œæ‰‹æœºå·
}
```

#### UpdateUserDto
```typescript
{
  openid?: string;     // å¯é€‰ï¼Œå¾®ä¿¡openid
  nickname?: string;   // å¯é€‰ï¼Œç”¨æˆ·æ˜µç§°
  avatar?: string;     // å¯é€‰ï¼Œå¤´åƒURL
  phone?: string;      // å¯é€‰ï¼Œæ‰‹æœºå·
}
```

---

## ä¸šåŠ¡é€»è¾‘

### ğŸ›¡ï¸ æ•°æ®éªŒè¯è§„åˆ™

#### 1. åˆ›å»ºç”¨æˆ·éªŒè¯
- **openid**: å¿…å¡«ï¼Œå­—ç¬¦ä¸²ç±»å‹
- **nickname**: å¯é€‰ï¼Œå­—ç¬¦ä¸²ç±»å‹
- **avatar**: å¯é€‰ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼ˆURLæ ¼å¼éªŒè¯å¯æ‰©å±•ï¼‰
- **phone**: å¯é€‰ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼ˆæ‰‹æœºå·æ ¼å¼éªŒè¯å¯æ‰©å±•ï¼‰

#### 2. æ›´æ–°ç”¨æˆ·éªŒè¯
- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„
- å­—æ®µç±»å‹éªŒè¯ä¸åˆ›å»ºæ—¶ç›¸åŒ
- è‡³å°‘éœ€è¦æä¾›ä¸€ä¸ªå­—æ®µè¿›è¡Œæ›´æ–°

#### 3. ä¸šåŠ¡è§„åˆ™
- **å”¯ä¸€æ€§**: openidåœ¨ç³»ç»Ÿä¸­å¿…é¡»å”¯ä¸€
- **å®Œæ•´æ€§**: åˆ é™¤ç”¨æˆ·å‰éœ€æ£€æŸ¥å…³è”è®¢å•
- **ä¸€è‡´æ€§**: ç”¨æˆ·ä¿¡æ¯æ›´æ–°éœ€è¦ä¿æŒæ•°æ®ä¸€è‡´æ€§

### ğŸ”„ çŠ¶æ€ç®¡ç†
ç”¨æˆ·æ¨¡å—ç›®å‰é‡‡ç”¨ç®€å•çš„æ´»è·ƒçŠ¶æ€ç®¡ç†ï¼Œå¯æ‰©å±•ä¸ºï¼š
- **æ´»è·ƒ**: æ­£å¸¸å¯ç”¨çŠ¶æ€
- **ç¦ç”¨**: ç®¡ç†å‘˜ç¦ç”¨çŠ¶æ€
- **åˆ é™¤**: è½¯åˆ é™¤çŠ¶æ€

---

## æŠ€æœ¯å®ç°

### ğŸ”§ æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **NestJS**: Webæ¡†æ¶å’Œä¾èµ–æ³¨å…¥
- **Prisma**: ORMæ•°æ®åº“è®¿é—®
- **TypeScript**: ç±»å‹å®‰å…¨
- **class-validator**: æ•°æ®éªŒè¯
- **Swagger**: APIæ–‡æ¡£ç”Ÿæˆ

### ğŸ“‹ æœåŠ¡å®ç°
```typescript
@Injectable()
export class UsersService {
  constructor(private readonly prisma: PrismaService) {}

  async create(createUserDto: CreateUserDto): Promise<User> {
    try {
      return await this.prisma.user.create({
        data: createUserDto,
      });
    } catch (error) {
      throw new BadRequestException(`Failed to create user: ${error.message}`);
    }
  }

  async findAll(): Promise<User[]> {
    try {
      return await this.prisma.user.findMany();
    } catch (error) {
      throw new InternalServerErrorException(`Failed to fetch users: ${error.message}`);
    }
  }

  async findOne(id: number): Promise<User> {
    const user = await this.prisma.user.findUnique({ where: { id } });
    if (!user) {
      throw new NotFoundException(`User with id ${id} not found`);
    }
    return user;
  }
}
```

### ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ

#### åˆ›å»ºç”¨æˆ·
```typescript
await this.prisma.user.create({
  data: {
    openid: dto.openid,
    nickname: dto.nickname,
    avatar: dto.avatar,
    phone: dto.phone,
  },
});
```

#### æŸ¥è¯¢ç”¨æˆ·ï¼ˆåŒ…å«å…³è”æ•°æ®ï¼‰
```typescript
await this.prisma.user.findUnique({
  where: { id },
  include: {
    orders: {
      include: {
        package: true,
        timeSlot: true,
        payments: true,
      },
    },
  },
});
```

### ğŸš¦ å¼‚å¸¸å¤„ç†
```typescript
// è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹
throw new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨');
throw new BadRequestException('ç”¨æˆ·åˆ›å»ºå¤±è´¥');
throw new InternalServerErrorException('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');

// ç»Ÿä¸€å¼‚å¸¸å¤„ç†
try {
  // ä¸šåŠ¡é€»è¾‘
} catch (error) {
  if (error instanceof NotFoundException) {
    throw error;
  }
  throw new BadRequestException(`æ“ä½œå¤±è´¥: ${error.message}`);
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ğŸ¯ å‰ç«¯é›†æˆç¤ºä¾‹

#### å¾®ä¿¡å°ç¨‹åºé›†æˆ
```javascript
// å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç™»å½•å’Œæ³¨å†Œ
wx.login({
  success: async (res) => {
    if (res.code) {
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const userInfo = await wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™'
      });
      
      // å‘é€åˆ°åç«¯åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
      const response = await wx.request({
        url: 'https://api.example.com/users',
        method: 'POST',
        data: {
          openid: res.code, // å®é™…åº”è¯¥é€šè¿‡åç«¯æ¢å–openid
          nickname: userInfo.userInfo.nickName,
          avatar: userInfo.userInfo.avatarUrl
        }
      });
      
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
      wx.setStorageSync('userInfo', response.data);
    }
  }
});
```

#### React å‰ç«¯ç¤ºä¾‹
```typescript
// ç”¨æˆ·æœåŠ¡ç±»
class UserService {
  private baseURL = '/api/users';

  // åˆ›å»ºç”¨æˆ·
  async createUser(userData: CreateUserDto): Promise<User> {
    const response = await fetch(this.baseURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData),
    });
    
    if (!response.ok) {
      throw new Error('åˆ›å»ºç”¨æˆ·å¤±è´¥');
    }
    
    return response.json();
  }

  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getUser(id: number): Promise<User> {
    const response = await fetch(`${this.baseURL}/${id}`);
    
    if (!response.ok) {
      throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
    }
    
    return response.json();
  }

  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  async updateUser(id: number, userData: UpdateUserDto): Promise<User> {
    const response = await fetch(`${this.baseURL}/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData),
    });
    
    if (!response.ok) {
      throw new Error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
    }
    
    return response.json();
  }
}

// React Hook ä½¿ç”¨ç¤ºä¾‹
function useUser(userId: number) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const userService = new UserService();

  const fetchUser = useCallback(async () => {
    setLoading(true);
    setError(null);
    
    try {
      const userData = await userService.getUser(userId);
      setUser(userData);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'è·å–ç”¨æˆ·å¤±è´¥');
    } finally {
      setLoading(false);
    }
  }, [userId]);

  useEffect(() => {
    if (userId) {
      fetchUser();
    }
  }, [userId, fetchUser]);

  const updateUser = async (updateData: UpdateUserDto) => {
    try {
      const updatedUser = await userService.updateUser(userId, updateData);
      setUser(updatedUser);
      return updatedUser;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æ›´æ–°å¤±è´¥');
      throw err;
    }
  };

  return { user, loading, error, updateUser, refetch: fetchUser };
}

// ç”¨æˆ·ä¿¡æ¯ç»„ä»¶
function UserProfile({ userId }: { userId: number }) {
  const { user, loading, error, updateUser } = useUser(userId);
  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState<UpdateUserDto>({});

  if (loading) return <div>åŠ è½½ä¸­...</div>;
  if (error) return <div>é”™è¯¯: {error}</div>;
  if (!user) return <div>ç”¨æˆ·ä¸å­˜åœ¨</div>;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await updateUser(formData);
      setIsEditing(false);
      alert('æ›´æ–°æˆåŠŸ');
    } catch (err) {
      alert('æ›´æ–°å¤±è´¥');
    }
  };

  return (
    <div>
      {!isEditing ? (
        <div>
          <h2>{user.nickname || 'æœªè®¾ç½®æ˜µç§°'}</h2>
          <img src={user.avatar} alt="å¤´åƒ" />
          <p>æ‰‹æœºå·: {user.phone || 'æœªè®¾ç½®'}</p>
          <button onClick={() => setIsEditing(true)}>ç¼–è¾‘èµ„æ–™</button>
        </div>
      ) : (
        <form onSubmit={handleSubmit}>
          <input
            type="text"
            placeholder="æ˜µç§°"
            value={formData.nickname || user.nickname || ''}
            onChange={(e) => setFormData({...formData, nickname: e.target.value})}
          />
          <input
            type="text"
            placeholder="æ‰‹æœºå·"
            value={formData.phone || user.phone || ''}
            onChange={(e) => setFormData({...formData, phone: e.target.value})}
          />
          <button type="submit">ä¿å­˜</button>
          <button type="button" onClick={() => setIsEditing(false)}>å–æ¶ˆ</button>
        </form>
      )}
    </div>
  );
}
```

### ğŸ”§ ç®¡ç†åå°ç¤ºä¾‹
```typescript
// ç”¨æˆ·ç®¡ç†é¡µé¢
function UserManagement() {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(false);
  const userService = new UserService();

  useEffect(() => {
    const fetchUsers = async () => {
      setLoading(true);
      try {
        const userData = await userService.getAllUsers();
        setUsers(userData);
      } catch (err) {
        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  return (
    <div>
      <h1>ç”¨æˆ·ç®¡ç†</h1>
      {loading ? (
        <div>åŠ è½½ä¸­...</div>
      ) : (
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>æ˜µç§°</th>
              <th>æ‰‹æœºå·</th>
              <th>æ³¨å†Œæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {users.map(user => (
              <tr key={user.id}>
                <td>{user.id}</td>
                <td>{user.nickname || 'æœªè®¾ç½®'}</td>
                <td>{user.phone || 'æœªè®¾ç½®'}</td>
                <td>{new Date(user.createdAt).toLocaleDateString()}</td>
                <td>
                  <button onClick={() => viewUserDetail(user.id)}>æŸ¥çœ‹</button>
                  <button onClick={() => editUser(user.id)}>ç¼–è¾‘</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}
```

---

## å®‰å…¨ç‰¹æ€§

### ğŸ”’ æ•°æ®å®‰å…¨
- **è¾“å…¥éªŒè¯**: æ‰€æœ‰è¾“å…¥æ•°æ®è¿›è¡Œæ ¼å¼éªŒè¯
- **SQLæ³¨å…¥é˜²æŠ¤**: é€šè¿‡Prisma ORMé˜²æ­¢SQLæ³¨å…¥
- **æ•°æ®è„±æ•**: æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ‰‹æœºå·ï¼‰å¯å®ç°è„±æ•æ˜¾ç¤º
- **è®¿é—®æ§åˆ¶**: å¯æ‰©å±•å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

### ğŸ›¡ï¸ éšç§ä¿æŠ¤
- **æœ€å°åŒ–åŸåˆ™**: åªæ”¶é›†å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯
- **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®å¯å®ç°æ•°æ®åº“çº§åˆ«åŠ å¯†
- **å®¡è®¡æ—¥å¿—**: è®°å½•ç”¨æˆ·æ•°æ®æ“ä½œæ—¥å¿—
- **GDPRåˆè§„**: æ”¯æŒç”¨æˆ·æ•°æ®åˆ é™¤å’Œå¯¼å‡º

### ğŸ” èº«ä»½è®¤è¯
```typescript
// JWTè®¤è¯è£…é¥°å™¨ç¤ºä¾‹
@Injectable()
export class JwtAuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const token = this.extractTokenFromHeader(request);
    
    if (!token) {
      throw new UnauthorizedException();
    }

    try {
      const payload = this.jwtService.verify(token);
      request['user'] = payload;
    } catch {
      throw new UnauthorizedException();
    }
    
    return true;
  }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
@UseGuards(JwtAuthGuard)
@Get('profile')
getProfile(@Request() req) {
  return this.usersService.findOne(req.user.sub);
}
```

---

## å¸¸è§é—®é¢˜

### â“ FAQ

#### Q1: å¦‚ä½•å¤„ç†å¾®ä¿¡openidçš„å”¯ä¸€æ€§å†²çªï¼Ÿ
**A**: åœ¨æ•°æ®åº“å±‚é¢è®¾ç½®openidå­—æ®µçš„å”¯ä¸€çº¦æŸï¼Œåº”ç”¨å±‚é¢æ•è·å†²çªå¼‚å¸¸å¹¶è¿”å›åˆé€‚çš„é”™è¯¯ä¿¡æ¯ã€‚

```typescript
try {
  return await this.prisma.user.create({ data: createUserDto });
} catch (error) {
  if (error.code === 'P2002') { // Prismaå”¯ä¸€çº¦æŸå†²çª
    throw new ConflictException('ç”¨æˆ·å·²å­˜åœ¨');
  }
  throw error;
}
```

#### Q2: å¦‚ä½•å®ç°ç”¨æˆ·è½¯åˆ é™¤ï¼Ÿ
**A**: åœ¨Useræ¨¡å‹ä¸­æ·»åŠ deletedAtå­—æ®µï¼Œåˆ é™¤æ—¶æ›´æ–°è¯¥å­—æ®µè€Œä¸æ˜¯ç‰©ç†åˆ é™¤ã€‚

```typescript
// Prisma schemaæ‰©å±•
model User {
  id        Int       @id @default(autoincrement())
  openid    String    @unique
  nickname  String?
  avatar    String?
  phone     String?
  deletedAt DateTime? // è½¯åˆ é™¤å­—æ®µ
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// è½¯åˆ é™¤å®ç°
async softDelete(id: number) {
  return await this.prisma.user.update({
    where: { id },
    data: { deletedAt: new Date() }
  });
}

// æŸ¥è¯¢æ—¶æ’é™¤å·²åˆ é™¤ç”¨æˆ·
async findAll() {
  return await this.prisma.user.findMany({
    where: { deletedAt: null }
  });
}
```

#### Q3: å¦‚ä½•å®ç°ç”¨æˆ·ä¿¡æ¯çš„åˆ†é¡µæŸ¥è¯¢ï¼Ÿ
**A**: ä½¿ç”¨Prismaçš„skipå’Œtakeå‚æ•°å®ç°åˆ†é¡µã€‚

```typescript
async findAllPaginated(page: number, limit: number) {
  const skip = (page - 1) * limit;
  
  const [users, total] = await Promise.all([
    this.prisma.user.findMany({
      skip,
      take: limit,
      where: { deletedAt: null },
      orderBy: { createdAt: 'desc' }
    }),
    this.prisma.user.count({
      where: { deletedAt: null }
    })
  ]);

  return {
    data: users,
    total,
    page,
    limit,
    totalPages: Math.ceil(total / limit)
  };
}
```

#### Q4: å¦‚ä½•éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼Ÿ
**A**: ä½¿ç”¨class-validatorçš„è£…é¥°å™¨è¿›è¡Œæ‰‹æœºå·æ ¼å¼éªŒè¯ã€‚

```typescript
import { Matches } from 'class-validator';

export class CreateUserDto {
  @ApiProperty({ description: 'ç”¨æˆ·æ‰‹æœºå·', required: false })
  @IsOptional()
  @IsString()
  @Matches(/^1[3-9]\d{9}$/, { message: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' })
  phone?: string;
}
```

#### Q5: å¦‚ä½•å¤„ç†ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼Ÿ
**A**: å¯ä»¥é›†æˆæ–‡ä»¶ä¸Šä¼ æœåŠ¡ï¼Œè¿”å›å¤´åƒURLã€‚

```typescript
@Post('upload-avatar')
@UseInterceptors(FileInterceptor('avatar'))
async uploadAvatar(
  @UploadedFile() file: Express.Multer.File,
  @Param('id') userId: number
) {
  // ä¸Šä¼ åˆ°äº‘å­˜å‚¨æœåŠ¡
  const avatarUrl = await this.fileService.upload(file);
  
  // æ›´æ–°ç”¨æˆ·å¤´åƒ
  return await this.usersService.update(userId, {
    avatar: avatarUrl
  });
}
```

### ğŸ› æ•…éšœæ’é™¤

#### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **ç”¨æˆ·åˆ›å»ºå¤±è´¥**
   ```
   é”™è¯¯: Failed to create user: Unique constraint failed
   è§£å†³: æ£€æŸ¥openidæ˜¯å¦å·²å­˜åœ¨ï¼Œè¿”å›ç”¨æˆ·å·²å­˜åœ¨çš„é”™è¯¯
   ```

2. **ç”¨æˆ·ä¸å­˜åœ¨**
   ```
   é”™è¯¯: User with id 1 not found
   è§£å†³: æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®ï¼Œç¡®è®¤ç”¨æˆ·æœªè¢«åˆ é™¤
   ```

3. **æ•°æ®éªŒè¯å¤±è´¥**
   ```
   é”™è¯¯: ValidationError: openid should not be empty
   è§£å†³: ç¡®ä¿å¿…å¡«å­—æ®µå·²æ­£ç¡®æä¾›
   ```

### ğŸ“ æŠ€æœ¯æ”¯æŒ
- **APIæ–‡æ¡£**: è®¿é—® `/api/docs` æŸ¥çœ‹Swaggeræ–‡æ¡£
- **é”™è¯¯æ—¥å¿—**: æŸ¥çœ‹åº”ç”¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
- **æ•°æ®åº“æ—¥å¿—**: æŸ¥çœ‹æ•°æ®åº“æ“ä½œæ—¥å¿—æ’æŸ¥é—®é¢˜

---

## æ€»ç»“

ç”¨æˆ·æ¨¡å—æ˜¯æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€æ¨¡å—ï¼Œæä¾›äº†ï¼š

âœ… **å®Œæ•´çš„ç”¨æˆ·ç®¡ç†**: ä»åˆ›å»ºåˆ°åˆ é™¤çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†  
âœ… **å¾®ä¿¡é›†æˆæ”¯æŒ**: å®Œç¾é›†æˆå¾®ä¿¡å°ç¨‹åºç”Ÿæ€  
âœ… **çµæ´»çš„æ•°æ®ç»“æ„**: æ”¯æŒå¯é€‰å­—æ®µå’Œæ‰©å±•éœ€æ±‚  
âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰  
âœ… **RESTfulè®¾è®¡**: æ ‡å‡†çš„REST APIæ¥å£  
âœ… **å®Œæ•´çš„æ–‡æ¡£**: è¯¦ç»†çš„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹  

è¯¥æ¨¡å—ä¸ºæ•´ä¸ªå©´å„¿æ‘„å½±å·¥ä½œå®¤ç³»ç»Ÿæä¾›äº†ç¨³å®šå¯é çš„ç”¨æˆ·ç®¡ç†åŸºç¡€ï¼Œæ”¯æŒåç»­åŠŸèƒ½æ¨¡å—çš„å¼€å‘å’Œé›†æˆã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0.0*  
*æœ€åæ›´æ–°: 2024å¹´7æœˆ25æ—¥*  
*ç»´æŠ¤è€…: å¼€å‘å›¢é˜Ÿ*
