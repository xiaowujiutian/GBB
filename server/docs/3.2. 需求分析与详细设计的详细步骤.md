# 2. 需求分析与详细设计的详细步骤

## 2.1 需求分析

1. **文档解读与需求梳理**
   - 详细阅读项目方案文档，提取核心功能点
   - 整理关键业务需求：预约系统、支付流程、客户管理、数据分析等
   - 列出功能模块清单，标记优先级（P0/P1/P2）

2. **用户角色与场景分析**
   - 识别核心用户角色：
     - 客户（家长）
     - 影楼管理员
     - 系统管理员
   - 为每个角色绘制用例图，明确功能权限

3. **业务流程梳理**
   ```markdown
   # 1. 客户预约流程
   客户浏览套餐 -> 选择套餐 -> 选择时间 -> 填写信息 -> 支付定金/全款 -> 预约确认
   
   # 2. 支付流程
   创建订单 -> 选择支付方式 -> 支付定金/全款 -> 支付结果处理 -> 状态更新
   
   # 3. 后台管理流程
   登录管理后台 -> 查看预约列表 -> 处理预约请求 -> 安排摄影时间 -> 收款/退款

   # 4. 查找功能流程
   ## 4.1 用户查找功能
   - 手机号码查找用户信息
   - 用户昵称查找用户信息
   - 手机号码查找用户订过的套系

   ## 4.2 订单查找功能  
   - 手机号码查找订单
   - 时间区间查找订单
   - 支付状态查找订单
   - 套系名称查找订单

   ## 4.3 套系查找功能
   - 价格区间查找套系

   ## 4.4 支付查找功能
   - 手机号码查找支付状态
   ```

## 2.2 数据模型设计

1. **细化数据库 ER 图**
   - 完善原有 ER 图中的实体关系
   - 添加缺失的实体表：
     ```
     PACKAGES {
         int id PK
         string name
         text description
         decimal price
         decimal deposit
         int duration_minutes
         string[] includes
         datetime created_at
     }
     
     TIME_SLOTS {
         int id PK
         date slot_date
         time start_time
         time end_time
         boolean is_booked
         datetime created_at
     }
     
     PAYMENTS {
         string payment_id PK
         string order_no FK
         string payment_type
         decimal amount
         string status
         string transaction_id
         datetime paid_at
     }
     ```

2. **设计数据库索引**
   ```sql
   -- 订单表索引
   CREATE INDEX idx_orders_user_id ON ORDERS(user_id);
   CREATE INDEX idx_orders_status ON ORDERS(order_status);
   CREATE INDEX idx_orders_payment_status ON ORDERS(payment_status);
   CREATE INDEX idx_orders_appointment_date ON ORDERS(appointment_date);
   CREATE INDEX idx_orders_package_id ON ORDERS(package_id);
   
   -- 时间段表索引
   CREATE INDEX idx_time_slots_date ON TIME_SLOTS(slot_date);
   CREATE INDEX idx_time_slots_booked ON TIME_SLOTS(is_booked);
   
   -- 用户表索引
   CREATE INDEX idx_users_phone ON USERS(phone);
   CREATE INDEX idx_users_nickname ON USERS(nickname);
   
   -- 套系表索引
   CREATE INDEX idx_packages_price ON PACKAGES(price);
   CREATE INDEX idx_packages_name ON PACKAGES(name);
   
   -- 支付表索引
   CREATE INDEX idx_payments_status ON PAYMENTS(status);
   CREATE INDEX idx_payments_order_no ON PAYMENTS(order_no);
   ```

## 2.3 API 接口设计

1. **完善 API 规范**
   - 根据业务流程细化必要接口：
     - 用户模块：登录、获取用户信息、更新用户信息
     - 套餐模块：获取套餐列表、套餐详情
     - 预约模块：查询可用时间、创建预约、取消预约
     - 支付模块：创建支付、查询支付状态
     - **查找模块：多维度查找功能**

2. **查找功能 API 文档模板**

   ## 用户查找接口

   ### 手机号码查找用户
   ```http
   GET /api/v1/search/users?phone=13800138000
   Authorization: Bearer {token}
   ```

   ### 用户昵称查找用户
   ```http
   GET /api/v1/search/users?nickname=张三
   Authorization: Bearer {token}
   ```

   ### 响应格式
   ```json
   {
     "code": 200,
     "data": [
       {
         "openid": "ox123456",
         "nickname": "张三",
         "phone": "13800138000",
         "avatar": "https://...",
         "created_at": "2024-01-01T00:00:00Z"
       }
     ]
   }
   ```

   ## 订单查找接口

   ### 手机号码查找订单
   ```http
   GET /api/v1/search/orders?phone=13800138000
   Authorization: Bearer {token}
   ```

   ### 时间区间查找订单
   ```http
   GET /api/v1/search/orders?start_date=2024-01-01&end_date=2024-01-31
   Authorization: Bearer {token}
   ```

   ### 支付状态查找订单
   ```http
   GET /api/v1/search/orders?payment_status=PAID
   Authorization: Bearer {token}
   ```

   ### 套系名称查找订单
   ```http
   GET /api/v1/search/orders?package_name=儿童写真套系A
   Authorization: Bearer {token}
   ```

   ## 套系查找接口

   ### 价格区间查找套系
   ```http
   GET /api/v1/search/packages?min_price=500&max_price=1500
   Authorization: Bearer {token}
   ```

   ## 支付查找接口

   ### 手机号码查找支付状态
   ```http
   GET /api/v1/search/payments?phone=13800138000
   Authorization: Bearer {token}
   ```

   ## 用户套系关联查找接口

   ### 手机号码查找用户订过的套系
   ```http
   GET /api/v1/search/user-packages?phone=13800138000
   Authorization: Bearer {token}
   ```

2. **API 文档模板**
   ```markdown
   ## 获取可用时间段
   
   ### 请求
   ```http
   GET /api/v1/time-slots?date=2024-08-01
   Authorization: Bearer {token}
   ```
   
   ### 参数
   | 参数名 | 类型 | 必填 | 说明 |
   |-------|------|-----|------|
   | date  | string | 是 | 查询日期，格式：YYYY-MM-DD |
   
   ### 响应
   ```json
   {
     "code": 200,
     "data": [
       {
         "id": 101,
         "date": "2024-08-01",
         "start_time": "09:00",
         "end_time": "10:30",
         "is_booked": false
       },
       {
         "id": 102,
         "date": "2024-08-01",
         "start_time": "11:00",
         "end_time": "12:30",
         "is_booked": false
       }
     ]
   }
   ```
   ```

## 2.4 设计文档输出

1. **编写详细的功能设计文档**
   - 功能模块设计
   - 页面结构与导航
   - 数据流程图

2. **制作交互原型**
   - 使用原型工具（如 Figma 或 Axure）绘制关键页面
   - 主要页面包括：
     - 首页/套餐列表
     - 套餐详情页
     - 预约时间选择页
     - 支付页面
     - 订单管理页
     - **查找功能页面**

3. **技术实现细节文档**
   - 支付流程实现方案
   - 预约冲突处理策略
   - 安全设计（认证与授权）
   - **查找功能性能优化方案**

## 2.5 成果验收标准

创建包含以下内容的验收标准文档：

```markdown
# 功能验收标准

## 用户模块
- [ ] 用户可以通过微信授权登录
- [ ] 用户可以编辑个人信息
- [ ] 用户可以查看历史订单

## 预约模块
- [ ] 用户可以浏览所有可用套餐
- [ ] 用户可以查看指定日期的可用时间段
- [ ] 用户可以成功提交预约申请
- [ ] 系统可以正确处理时间冲突

## 支付模块
- [ ] 用户可以支付定金或全款
- [ ] 系统能准确记录支付状态
- [ ] 支付成功后自动发送通知

## 查找功能模块
### 用户查找功能
- [ ] 可以通过手机号码精确查找用户信息
- [ ] 可以通过用户昵称模糊查找用户信息
- [ ] 查找结果显示完整的用户基本信息

### 订单查找功能
- [ ] 可以通过手机号码查找用户的所有订单
- [ ] 可以通过时间区间查找指定时间段的订单
- [ ] 可以通过支付状态筛选订单
- [ ] 可以通过套系名称查找相关订单

### 套系查找功能
- [ ] 可以通过价格区间查找符合条件的套系
- [ ] 查找结果按价格排序显示

### 支付查找功能
- [ ] 可以通过手机号码查找用户的支付记录和状态
- [ ] 显示详细的支付信息包括金额、状态、时间

### 关联查找功能
- [ ] 可以通过手机号码查找用户订过的所有套系
- [ ] 显示套系详情和订购历史
```

以上详细步骤将帮助单人开发者系统性地完成需求分析与详细设计阶段的工作，为后续的开发奠定坚实基础。