# 🔍 查找模块功能说明文档

## 目录
- [模块概述](#模块概述)
- [核心功能](#核心功能)
- [API 接口详情与测试示例](#api-接口详情与测试示例)
- [数据模型与关联](#数据模型与关联)
- [技术实现要点](#技术实现要点)
- [安全与性能考量](#安全与性能考量)
- [测试数据示例](#测试数据示例)

---

## 模块概述

### 🎯 功能定位
查找模块是系统的核心数据检索中心，为小程序前台和管理后台提供强大、灵活的数据查询能力。它聚合了用户、订单、套餐、支付等多个模块的数据，支持多维度、多条件的复杂查询，是运营管理、客户服务和数据分析的基础。

### 🚀 主要特性
- **多维度查询**: 支持按手机号、昵称、时间、价格、状态等多种条件查询。
- **关联查询**: 支持跨模块的关联数据查找，如“查找某用户订购过的所有套餐”。
- **模糊与精确查询**: 支持精确匹配和模糊搜索，满足不同场景需求。
- **分页与排序**: 所有列表查询均支持分页和排序，提升性能和用户体验。
- **性能优化**: 关键查询字段已建立数据库索引，确保大数据量下的查询效率。

---

## 核心功能

- **用户查找**: 根据手机号、昵称等信息查找用户。
- **订单查找**: 根据手机号、时间区间、支付状态、套餐名称等查找订单。
- **套餐查找**: 根据价格区间、名称等查找套餐。
- **支付查找**: 根据手机号、订单号等查找支付记录。
- **关联查找**: 实现跨实体的复杂业务查询。

---

## API 接口详情与测试示例

本部分提供了查找模块核心 API 的说明，并附上了可在 Swagger UI (`/api/docs`) 中直接使用的测试参数。

### 1. 用户查找

#### 1.1 根据手机号查找用户 (GET /users/by-phone/:phone)

- **功能**: 精确查找指定手机号的用户信息。
- **测试参数**:
  - `phone`: `13800138000` (使用一个已存在的手机号)
  - `phone`: `99999999999` (使用一个不存在的手机号)

#### 1.2 根据昵称查找用户 (GET /users/by-nickname/:nickname)

- **功能**: 模糊查找包含指定昵称关键词的用户列表。
- **测试参数**:
  - `nickname`: `张` (查找所有姓张或名字里带“张”的用户)

### 2. 订单查找

#### 2.1 根据手机号查找订单 (GET /orders/by-phone/:phone)

- **功能**: 查找指定手机号关联的所有订单。
- **测试参数**:
  - `phone`: `13800138000`

#### 2.2 根据时间区间查找订单 (GET /orders/by-date-range)

- **功能**: 查找在指定日期范围内的所有订单。
- **Query 参数**:
  - `startDate`: `2024-01-01`
  - `endDate`: `2024-01-31`

#### 2.3 根据支付状态查找订单 (GET /orders/by-payment-status/:status)

- **功能**: 查找具有特定支付状态的所有订单。
- **测试参数**:
  - `status`: `PAID`
  - `status`: `PENDING`

### 3. 套餐查找

#### 3.1 根据价格区间查找套餐 (GET /packages/by-price-range)

- **功能**: 查找在指定价格范围内的所有套餐。
- **Query 参数**:
  - `minPrice`: `500`
  - `maxPrice`: `1500`

### 4. 关联查找

#### 4.1 根据手机号查找用户订购过的套餐 (GET /users/packages/by-phone/:phone)

- **功能**: 查找指定手机号的用户历史上订购过的所有套餐列表。
- **测试参数**:
  - `phone`: `13800138000`

---

## 数据模型与关联

查找功能的实现依赖于各模块之间清晰的数据模型和关联关系。

- **User ↔ Order**: 一对多。通过 `Order.userId` 关联。
- **Package ↔ Order**: 一对多。通过 `Order.packageId` 关联。
- **Order ↔ Payment**: 一对多。通过 `Payment.orderId` 关联。

这些关联关系使得可以从一个实体出发，高效地查询到所有相关的数据。

---

## 技术实现要点

- **Prisma `include`**: 用于在查询主模型时，同时加载关联模型的数据。
- **Prisma `where`**: 用于构建复杂的过滤条件，支持 `AND`, `OR`, `NOT` 逻辑。
- **Prisma `contains`**: 用于实现字符串的模糊查询。
- **Prisma `gte` / `lte`**: 用于实现日期和数值的范围查询。
- **Prisma `skip` / `take`**: 用于实现分页。
- **数据库索引**: 在 `phone`, `orderNo`, `createdAt`, `price` 等常用查询字段上创建索引，大幅提升查询性能。

---

## 安全与性能考量

- **输入验证**: 所有查询参数都经过 `class-validator` 的严格验证，防止恶意输入和注入攻击。
- **权限控制**: 敏感的查找接口（如后台管理使用的接口）应通过 `Guard` 进行权限校验，防止未授权访问。
- **性能优化**:
  - 避免在无索引的字段上进行模糊查询。
  - 对返回的大数据列表强制使用分页。
  - 使用 `select` 精确选择需要的字段，减少数据传输量。

---

## 测试数据示例

为了方便测试查找功能，可以向数据库中填充以下示例数据。

### 用户数据 (Users)

```json
[
  {
    "openid": "test_openid_001",
    "nickname": "张小宝",
    "phone": "13800138000"
  },
  {
    "openid": "test_openid_002",
    "nickname": "李乐乐",
    "phone": "13900139001"
  },
  {
    "openid": "test_openid_003",
    "nickname": "张三丰",
    "phone": "13700137002"
  }
]
```

### 套餐数据 (Packages)

```json
[
  {
    "name": "百日照基础套餐",
    "description": "记录宝宝百日瞬间",
    "price": 499,
    "duration": 60,
    "isActive": true
  },
  {
    "name": "周岁照豪华套餐",
    "description": "庆祝宝宝一岁生日",
    "price": 1299,
    "duration": 120,
    "isActive": true
  },
  {
    "name": "亲子互动套餐",
    "description": "温馨的家庭时光",
    "price": 1699,
    "duration": 90,
    "isActive": false
  }
]
```

### 订单数据 (Orders)

假设用户ID和套餐ID与上述数据对应，并已创建好相应的时间槽。

```json
[
  {
    "userId": 1,
    "packageId": 1,
    "timeSlotId": 1,
    "contactPhone": "13800138000",
    "status": "COMPLETED",
    "paymentStatus": "PAID",
    "totalAmount": 499,
    "createdAt": "2024-01-10T10:00:00.000Z"
  },
  {
    "userId": 2,
    "packageId": 2,
    "timeSlotId": 2,
    "contactPhone": "13900139001",
    "status": "CONFIRMED",
    "paymentStatus": "PENDING",
    "totalAmount": 1299,
    "createdAt": "2024-01-20T14:00:00.000Z"
  },
  {
    "userId": 1,
    "packageId": 2,
    "timeSlotId": 3,
    "contactPhone": "13800138000",
    "status": "COMPLETED",
    "paymentStatus": "PAID",
    "totalAmount": 1299,
    "createdAt": "2024-02-05T11:00:00.000Z"
  }
]
```
