####  端口3000被占有的解决办法
1、首先检查是否有其他进程在使用3000端口：
lsof -i :3000 || netstat -tlnp | grep :3000

命令显示：
liyong@dely:~/gbb/server/baby-photo-backend$ lsof -i :3000 || netstat -tlnp | grep :3000
COMMAND     PID   USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
node    3797128 liyong   31u  IPv6 37674523      0t0  TCP *:3000 (LISTEN)

有一个node进程正在占用3000端口。让我们停止它：
在终端执行命令：
kill -9 3797128


现在再次检查端口是否释放：

lsof -i :3000
没显示代表端口3000被释放

现在让我们重新启动开发服务器。首先确保我们在正确的目录：
pwd

让我先检查当前目录结构：
ls -la

### 成功启动服务器
在 `/home/liyong/gbb/server/baby-photo-backend` 目录执行：
```bash
pnpm run start:dev
```

#### 现在让我重新启动开发服务器以应用修复
pkill -f "nest start"

pnpm run start:dev
####  Swagger UI 使用指南
服务器启动成功后，可以看到以下信息：
- 🚀 乖宝宝儿童影楼管理系统启动成功!
- 🌐 服务地址: http://localhost:3000
- 📚 API 文档: http://localhost:3000/api/docs
- 🏥 健康检查: http://localhost:3000/api/v1/health

### 健康检查验证
访问 `http://localhost:3000/api/v1/health` 返回：
```json
{
  "status": "ok",
  "message": "系统运行正常",
  "timestamp": "2025-07-25T04:56:24.108Z",
  "uptime": "1652秒",
  "version": "1.0.0",
  "environment": "development",
  "services": {
    "database": "connected",
    "redis": "connected"
  }
}
```
####
## API 接口测试指南


### 1. 使用 Swagger UI 进行接口测试

访问 `http://localhost:3000/api/docs` 可以看到完整的 API 文档界面，包含以下功能：

#### 📋 主要模块接口
- **系统信息** - 系统健康检查、版本信息
- **用户管理** (users) - 用户增删改查
- **套餐管理** (packages) - 套餐增删改查  
- **订单管理** (orders) - 订单增删改查
- **支付管理** (payments) - 支付记录管理
- #### 3. 创建时间槽
找到 **time-slots** → **POST /api/v1/time-slots**，使用以下数据：
```json
{
  "date": "2025-08-15",
  "startTime": "10:00:00",
  "endTime": "12:00:00"
}
```

#### 🧪 测试步骤
1. **打开接口文档**: 在浏览器访问 `http://localhost:3000/api/docs`
2. **选择要测试的接口**: 点击对应模块展开接口列表
3. **点击 "Try it out" 按钮**: 进入测试模式
4. **填写请求参数**: 
   - 路径参数 (Path Parameters)
   - 查询参数 (Query Parameters) 
   - 请求体 (Request Body)
5. **点击 "Execute" 按钮**: 发送请求
6. **查看响应结果**: 
   - Response Code (状态码)
   - Response Body (响应内容)
   - Response Headers (响应头)

### 2. 常用接口测试示例

#### 2.1 测试系统接口
```bash
# 健康检查
GET http://localhost:3000/api/v1/health

# 系统版本信息
GET http://localhost:3000/api/v1/version

# 系统欢迎信息
GET http://localhost:3000/api/v1
```

#### 2.2 测试用户接口
```bash
# 获取所有用户
GET http://localhost:3000/api/v1/users

# 创建用户
POST http://localhost:3000/api/v1/users
Content-Type: application/json
{
  "openid": "test_openid_123",
  "nickname": "测试用户",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13800138000"
}

# 获取单个用户
GET http://localhost:3000/api/v1/users/1
```

#### 2.3 测试套餐接口
```bash
# 获取所有套餐
GET http://localhost:3000/api/v1/packages

# 创建套餐
POST http://localhost:3000/api/v1/packages
Content-Type: application/json
**创建套餐**：
```json
{
  "name": "经典亲子摄影套餐",
  "description": "包含亲子照片拍摄、精修照片等服务",
  "price": 899.00,
  "deposit": 200.00,
  "durationMinutes": 120,
  "includes": [
    "专业摄影师拍摄",
    "30张精修照片",
    "10张相册装订",
    "化妆造型服务",
    "服装道具提供"
  ]
}
```

### 常见接口测试错误及解决方案

#### 1. 套餐创建接口验证错误
**错误信息**：
```json
{
  "message": [
    "property originalPrice should not exist",
    "property duration should not exist", 
    "property photoCount should not exist",
    "property isActive should not exist",
    "deposit must not be less than 0",
    "deposit must be a number conforming to the specified constraints",
    "durationMinutes must not be less than 15",
    "durationMinutes must be a number conforming to the specified constraints",
    "each value in includes must be a string",
    "includes must be an array"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```

**解决方案**：
- ❌ 错误的字段名：`originalPrice`, `duration`, `photoCount`, `isActive`
- ✅ 正确的字段名：`price`, `deposit`, `durationMinutes`, `includes`
- ✅ `deposit` 必须是数字且 ≥ 0
- ✅ `durationMinutes` 必须是数字且 ≥ 15 分钟
- ✅ `includes` 必须是字符串数组

**正确的创建套餐数据**：
```json
{
  "name": "经典亲子摄影套餐",
  "description": "包含亲子照片拍摄、精修照片等服务", 
  "price": 899,
  "deposit": 200,
  "durationMinutes": 120,
  "includes": ["专业摄影师拍摄", "30张精修照片", "化妆造型服务"]
}
```
```

### 3. 使用其他工具测试

#### 3.1 使用 curl 命令
```bash
# 健康检查
curl -X GET http://localhost:3000/api/v1/health

# 创建用户
curl -X POST http://localhost:3000/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{
    "openid": "test_openid_123",
    "nickname": "测试用户",
    "phone": "13800138000"
  }'
```

#### 3.2 使用 Postman
1. 导入 API 文档：在 Postman 中选择 "Import" > "Link"
2. 输入 `http://localhost:3000/api/docs-json` 导入 OpenAPI 规范
3. 自动生成所有接口的请求模板
4. 逐个测试各接口功能

#### 3.3 使用 VS Code REST Client
安装 REST Client 扩展，创建 `.http` 文件：
```http
### 健康检查
GET http://localhost:3000/api/v1/health

### 创建用户
POST http://localhost:3000/api/v1/users
Content-Type: application/json

{
  "openid": "test_openid_123",
  "nickname": "测试用户",
  "phone": "13800138000"
}

### 获取所有套餐
GET http://localhost:3000/api/v1/packages
```

### 4. 常见测试场景

#### 4.1 数据验证测试
- 测试必填字段缺失的情况
- 测试数据格式错误的情况
- 测试数据长度超限的情况

#### 4.2 业务流程测试
1. 创建用户 → 创建套餐 → 创建订单 → 创建支付
2. 查询用户的所有订单
3. 查询订单的支付记录
4. 更新订单状态

#### 4.3 错误处理测试
- 访问不存在的资源 (404)
- 发送无效的请求数据 (400)
- 测试服务器内部错误处理 (500)

当您测试创建接口时，可以使用以下示例数据：

**创建用户**：
```json
{
  "openid": "test_openid_001",
  "nickname": "小宝贝妈妈",
  "avatar": "https://example.com/avatar.jpg",
  "phone": "13800138000"
}
```

**创建套餐**：
```json
{
  "name": "经典亲子摄影套餐",
  "description": "包含亲子照片拍摄、精修照片等服务",
  "price": 899,
  "deposit": 200,
  "durationMinutes": 120,
  "includes": [
    "专业摄影师拍摄",
    "30张精修照片",
    "10张相册装订",
    "化妆造型服务",
    "服装道具提供"
  ]
}
```

**创建订单**：
```json
{
  "userId": 1,
  "packageId": 1,
  "timeSlotId": 1,
  "appointmentDate": "2025-08-15T10:00:00Z",
  "notes": "希望拍摄温馨的亲子照片",
  "childrenCount": 1
}
```

**创建支付**：
```json
{
  "orderId": "bbc409ff-ef50-493c-b64d-b147c58cea6a",
  "paymentType": "DEPOSIT",
  "amount": 200.00
}
```
**注意**：`orderId` 必须使用创建订单时返回的完整UUID，不是数字1。

**创建时间槽**：
```json
**创建时间槽**：
```json
{
  "date": "2025-08-15",
  "startTime": "10:00:00",
  "endTime": "12:00:00"
}
```

### 常见接口测试错误及解决方案

#### 1. 套餐创建接口验证错误
**错误信息**：
```json
{
  "message": [
    "property originalPrice should not exist",
    "property duration should not exist", 
    "property photoCount should not exist",
    "property isActive should not exist",
    "deposit must not be less than 0",
    "deposit must be a number conforming to the specified constraints",
    "durationMinutes must not be less than 15",
    "durationMinutes must be a number conforming to the specified constraints",
    "each value in includes must be a string",
    "includes must be an array"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```

**解决方案**：
- ❌ 错误的字段名：`originalPrice`, `duration`, `photoCount`, `isActive`
- ✅ 正确的字段名：`price`, `deposit`, `durationMinutes`, `includes`
- ✅ `deposit` 必须是数字且 ≥ 0
- ✅ `durationMinutes` 必须是数字且 ≥ 15 分钟
- ✅ `includes` 必须是字符串数组

**正确的创建套餐数据**：
```json
{
  "name": "经典亲子摄影套餐",
  "description": "包含亲子照片拍摄、精修照片等服务", 
  "price": 899,
  "deposit": 200,
  "durationMinutes": 120,
  "includes": ["专业摄影师拍摄", "30张精修照片", "化妆造型服务"]
}
```

#### 2. 时间槽创建接口验证错误
**错误信息**：
```json
{
  "message": [
    "property isAvailable should not exist",
    "property maxBookings should not exist",
    "开始时间格式必须为 HH:MM:SS",
    "结束时间格式必须为 HH:MM:SS"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```

**解决方案**：
- ❌ 错误的字段：`isAvailable`, `maxBookings`（这些字段不存在于 CreateTimeSlotDto 中）
- ❌ 错误的时间格式：`"10:00"`, `"12:00"`
- ✅ 正确的时间格式：`"10:00:00"`, `"12:00:00"`（必须包含秒数）
- ✅ 只需要三个字段：`date`, `startTime`, `endTime`

**正确的创建时间槽数据**：
```json
{
  "date": "2024-08-15",
  "startTime": "10:00:00",
  "endTime": "12:00:00"
}
```

#### 3. 时间槽日期验证错误
**错误信息**：
```json
{
  "message": "Date cannot be in the past",
  "error": "Bad Request",
  "statusCode": 400
}
```

**解决方案**：
- ❌ 问题：使用了过去的日期（如 `2024-08-15`）
- ✅ 解决：使用未来的日期（当前日期是 2025-07-25）

**正确的创建时间槽数据（使用未来日期）**：
```json
{
  "date": "2025-08-15",
  "startTime": "09:00:00",
  "endTime": "11:00:00"
}
```

或者使用今天之后的日期：
```json
{
  "date": "2025-07-26",
  "startTime": "10:00:00", 
  "endTime": "12:00:00"
}
```

#### 4. 支付创建接口订单ID错误
**错误信息**：
```json
{
  "message": "Order with id 1 not found",
  "error": "Not Found",
  "statusCode": 404
}
```

**问题分析**：
- ❌ 问题：使用了错误的订单ID（如 `"1"`）
- 订单实际ID是UUID格式：`"bbc409ff-ef50-493c-b64d-b147c58cea6a"`
- 支付接口的 `orderId` 字段必须是字符串类型的实际订单ID

**解决方案**：
1. **复制真实的订单ID**：从创建订单的响应中复制完整的UUID
2. **使用正确的订单ID格式**：完整的UUID字符串

**正确的创建支付数据**：
```json
{
  "orderId": "bbc409ff-ef50-493c-b64d-b147c58cea6a",
  "paymentType": "DEPOSIT",
  "amount": 200.00
}
```

**测试流程建议**：
1. 创建订单后，记录返回的完整订单ID（UUID格式）
2. 在创建支付时，使用这个完整的UUID作为 `orderId`
3. 确保 `amount` 与订单的 `depositAmount` 一致

#### 5. 根据ID查找用户接口错误
**错误信息**：
```json
{
  "message": "User with openid 1 not found",
  "error": "Not Found",
  "statusCode": 404
}
```

**问题分析**：
- ❌ 问题：控制器方法 `findOne` 错误地调用了 `findByOpenid()` 方法
- 数字ID `1` 被当作 `openid` 字符串来查询，导致查找失败
- 应该根据数字ID查询，而不是根据openid查询

**解决方案**：
修改 `src/modules/users/users.controller.ts` 文件中的 `findOne` 方法：

```typescript
// 错误的代码
@Get(':id')
findOne(@Param('id', ParseIntPipe) id: number) {
  return this.usersService.findByOpenid(id.toString()); // ❌ 错误
}

// 正确的代码
@Get(':id')
findOne(@Param('id', ParseIntPipe) id: number) {
  return this.usersService.findOne(id); // ✅ 正确
}
```

**修复后的测试**：
- 访问 `GET /api/v1/users/1` 应该正常返回用户信息
- 确保使用数字ID而不是openid进行查询
```

这样您就可以全面测试乖宝宝儿童影楼管理系统的各个接口功能了！🚀