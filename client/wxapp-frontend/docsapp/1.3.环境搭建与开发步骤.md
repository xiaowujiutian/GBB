# 微信小程序端开发环境搭建与详细开发测试步骤

## 一、开发环境搭建

### 1. Linux (Debian) + VS Code + Copilot
- 安装 VS Code（官网下载 .deb 包或通过 apt 安装）
- 安装 Copilot 插件（VS Code 插件市场搜索“GitHub Copilot”并安装）
- 安装 Node.js（推荐 v18+，用于前端依赖管理和工具链）
  ```bash
  sudo apt update
  sudo apt install nodejs npm
  node -v
  npm -v
  ```
- 安装微信小程序依赖（如 vant-weapp）
  ```bash

  注意：：
  
  使用npm 安装vant-weapp后，生成的文件在
  /home/liyong/gbb/client/wxapp-frontend/node_modules/@vant/weapp/dist
  目录下，传到windows下的微信开发者工具中既可以使用；


  npm install @vant/weapp --save


  ```
- 集成 vant-weapp 组件库
  1. 在 `miniprogram_npm` 目录下自动生成 vant-weapp 组件（微信开发者工具菜单：工具 -> 构建 npm）
  2. 在页面的 `json` 文件中注册所需组件，例如：
     ```json
     {
       "usingComponents": {
         "van-button": "@vant/weapp/button/index",
         "van-cell": "@vant/weapp/cell/index"
       }
     }
     ```
  3. 在 WXML 中直接使用 vant 组件标签，如
   `<van-button type="primary">按钮</van-button>`
- 初始化项目目录
  ```bash
  mkdir -p /home/liyong/gbb/client/wxapp-frontend
  cd /home/liyong/gbb/client/wxapp-frontend
  # 可用微信开发者工具初始化，也可手动创建
  ```

### 2. Windows 10 微信开发者工具
- 官网下载并安装微信开发者工具（https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html）
- 打开工具，导入 Linux 端开发的项目（可通过 Git 拉取或文件同步）

## 二、详细开发步骤

### 1. 项目初始化
- 在 VS Code 中新建小程序项目结构：
  ```
  /home/liyong/gbb/client/wxapp-frontend/
  ├── app.js
  ├── app.json
  ├── project.config.json
  ├── pages/
  │   ├── index/
  │   │   ├── index.js
  │   │   ├── index.json
  │   │   ├── index.wxml
  │   │   └── index.wxss
  │   ├── package-detail/
  │   ├── booking/
  │   ├── order-list/
  │   ├── order-detail/
  │   ├── payment/
  │   ├── search/
  │   └── profile/
  ├── components/
  ├── utils/
  │   └── api.js
  └── node_modules/
  ```
- 配置 `app.json`，注册页面路径：
  ```json
  {
    "pages": [
      "pages/index/index",
      "pages/package-detail/index",
      "pages/booking/index",
      "pages/order-list/index",
      "pages/order-detail/index",
      "pages/payment/index",
      "pages/search/index",
      "pages/profile/index"
    ],
    "window": {
      "navigationBarTitleText": "乖宝宝儿童影楼",
      "navigationBarBackgroundColor": "#fff",
      "navigationBarTextStyle": "black"
    },
    "style": "v2"
  }
  ```
- 配置 `project.config.json`，设置项目名、appid、网络域名等（示例）：
  ```json
  {
    "miniprogramRoot": "./",
    "projectname": "gbb-baby-photo",
    "appid": "wx1234567890abcdef",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "networkTimeout": {
      "request": 10000,
      "connectSocket": 10000,
      "uploadFile": 10000,
      "downloadFile": 10000
    }
  }
  ```
- 配置 vant-weapp 组件库（以首页为例，`pages/index/index.json`）：
  ```json
  {
    "usingComponents": {
      "van-button": "@vant/weapp/button/index",
      "van-cell": "@vant/weapp/cell/index"
    }
  }
  ```
- 在 WXML 文件中直接使用 vant 组件标签，例如：
  ```xml
  <!-- pages/index/index.wxml -->
  <van-button type="primary">预约拍摄</van-button>
  <van-cell title="套餐列表" />
  ```
- 统一 API 封装（如 utils/api.js，处理请求、token、错误提示）

### 2. 业务开发流程
- 按照功能模块逐步开发页面（index、package-detail、booking、order-list、order-detail、payment、search、profile）
  - 每个页面建议结构如下：
    ```
    pages/
      ├── 页面名/
      │   ├── index.js   // 页面逻辑
      │   ├── index.wxml // 页面模板
      │   ├── index.wxss // 页面样式
      │   └── index.json // 组件注册
    ```
- 每个页面开发步骤：
  1. 设计 WXML 结构和 WXSS 样式，布局内容区、操作区、列表区等。
  2. 编写 JS 逻辑，处理页面数据、生命周期、事件响应，调用后端 API（如通过 utils/api.js）。
  3. 在页面的 `json` 文件注册所需 vant-weapp 组件，如：
     ```json
     {
       "usingComponents": {
         "van-button": "@vant/weapp/button/index",
         "van-cell": "@vant/weapp/cell/index",
         "van-field": "@vant/weapp/field/index"
       }
     }
     ```
  4. 在 WXML 中使用 vant 组件标签，提升交互体验，如：
     ```xml
     <van-cell title="套餐名称" value="{{package.name}}" />
     <van-button type="primary" bindtap="onBookingTap">立即预约</van-button>
     <van-field label="手机号" value="{{contactPhone}}" bindinput="onPhoneInput" />
     ```
  5. 统一 API 封装（如 utils/api.js），所有网络请求通过 request 方法，自动处理 token、错误提示、loading 状态。
     ```javascript
     // utils/api.js
     export function request({ url, method = 'GET', data = {}, header = {} }) {
       // ...统一处理逻辑...
     }
     ```
  6. 页面间跳转、数据传递建议使用 wx.navigateTo 和本地缓存（如 wx.setStorageSync）。

- 业务开发建议：
  - 1、首页（index）：加载套餐列表，支持筛选、排序，点击进入详情。
  - 2、套餐详情（package-detail）：展示套餐详细信息，跳转预约。
  - 3、预约（booking）：选择日期、时间槽，填写信息，提交订单。
  - 4、订单列表（order-list）：展示我的订单，支持筛选、分页。
  - 5、订单详情（order-detail）：展示订单详情，支持支付、取消。
  - 6、支付（payment）：选择支付类型，发起微信支付，处理结果。
  - 7、查找（search）：支持手机号/昵称查找用户和订单，展示结果。
  - 8、用户中心（profile）：展示和编辑个人信息，查看历史订单。

- 每个页面建议先实现静态结构，再逐步接入后端 API，最后完善交互和体验。

### 3. 前后端联调与测试

#### 前端测试步骤
- 在 VS Code 编写代码，保存后同步到 Windows 10
  - 推荐使用 Git 进行代码版本管理和同步：
    1. 在 Linux 和 Windows 10 上分别安装 Git。
    2. 在 Linux 端将项目初始化为 Git 仓库，推送到远程仓库（如 GitHub、Gitee）。
    3. 在 Windows 10 上通过 Git 克隆仓库，随时拉取最新代码。
    4. 每次在 VS Code 编写并保存代码后，使用 `git add . && git commit -m "更新说明" && git push` 上传到远程仓库。
    5. 在 Windows 10 微信开发者工具项目目录下执行 `git pull`，同步最新代码。
  - 或者使用文件同步工具（如 Syncthing、rsync、网盘等）实现自动同步项目文件夹。
  - 确保同步后在微信开发者工具中点击“重新编译”或“刷新项目”，加载最新代码。
- 用微信开发者工具打开项目，真机预览和调试
  1. 在 Windows 10 上启动微信开发者工具，点击“添加项目”。
  2. 选择项目目录（如 `/home/liyong/gbb/client/wxapp-frontend` 同步到本地的 Windows 路径）。
  3. 填写小程序 AppID（如测试可用“体验版”AppID），项目类型选择“小程序”。
  4. 点击“确定”进入项目，工具会自动编译并预览代码。
  5. 在工具左侧点击“预览”按钮，生成二维码，用微信扫码可在真机上预览小程序效果。
  6. 可使用“真机调试”功能，连接手机后实时查看日志、网络请求和页面表现，便于调试和排查问题。
  7. 如需调试 API 请求，确保后端服务已启动且 API 域名已配置为合法域名。
  8. 修改代码后，点击“重新编译”或“刷新项目”即可实时查看最新效果。
- 检查页面跳转、数据展示、交互逻辑
  1. 在微信开发者工具中，逐步点击各页面入口（如首页套餐卡片、预约按钮等），确认页面跳转路径和参数传递是否正确。
  2. 检查各页面的数据加载情况，确保接口返回的数据能正确渲染到页面（如套餐列表、订单详情、查找结果等）。
  3. 测试表单输入、筛选、按钮点击等交互逻辑，观察事件响应是否符合预期（如预约提交、支付流程、编辑资料等）。
  4. 使用微信开发者工具的“调试”面板，查看 console 日志、网络请求、数据绑定和事件触发情况，及时发现和修复问题。
  5. 在真机预览下，重点测试页面跳转、数据展示和交互体验，确保与模拟器一致。
  6. 建议编写简单的测试用例或 checklist，逐项验证核心功能流程。
- 使用 mock 数据或本地后端接口进行初步测试
  1. mock 数据测试：在页面 JS 文件中直接定义模拟数据（如套餐列表、订单详情），用于前端开发和UI调试，无需依赖后端接口。
     ```javascript
     // pages/index/index.js
     Page({
       data: {
         packages: [
           { id: 1, name: '亲子套餐', price: 899, description: '专业摄影师服务', duration: 120, features: ['精修20张', '服装租赁'] },
           { id: 2, name: '全家福套餐', price: 1299, description: '全家福拍摄', duration: 180, features: ['大尺寸相框', '精装相册'] }
         ],
         loading: false
       }
     });
     ```
  2. 本地后端接口测试：在微信开发者工具“项目详情”中配置本地后端 API 域名（如 http://localhost:3000），确保接口可访问。
     - 启动后端服务（NestJS），确认接口可用。
     - 在前端请求中使用本地 API 地址，调试真实数据流和业务逻辑。
     - 可结合 Postman/Swagger UI 验证接口数据格式，确保前后端联调顺畅。
  3. 切换 mock 数据和真实接口时，可通过环境变量或配置文件控制，便于开发和测试。

- 检查页面跳转、数据展示、交互逻辑

  1. 在微信开发者工具中，逐步点击各页面入口（如首页套餐卡片、预约按钮等），确认页面跳转路径和参数传递是否正确。
  2. 检查各页面的数据加载情况，确保接口返回的数据能正确渲染到页面（如套餐列表、订单详情、查找结果等）。
  3. 测试表单输入、筛选、按钮点击等交互逻辑，观察事件响应是否符合预期（如预约提交、支付流程、编辑资料等）。
  4. 使用微信开发者工具的“调试”面板，查看 console 日志、网络请求、数据绑定和事件触发情况，及时发现和修复问题。
  5. 在真机预览下，重点测试页面跳转、数据展示和交互体验，确保与模拟器一致。
  6. 建议编写简单的测试用例或 checklist，逐项验证核心功能流程。

- 使用 mock 数据或本地后端接口进行初步测试

  1. mock 数据测试：在页面 JS 文件中直接定义模拟数据（如套餐列表、订单详情），用于前端开发和UI调试，无需依赖后端接口。
     ```javascript
     // pages/index/index.js
     Page({
       data: {
         packages: [
           { id: 1, name: '亲子套餐', price: 899, description: '专业摄影师服务', duration: 120, features: ['精修20张', '服装租赁'] },
           { id: 2, name: '全家福套餐', price: 1299, description: '全家福拍摄', duration: 180, features: ['大尺寸相框', '精装相册'] }
         ],
         loading: false
       }
     });
     ```
  2. 本地后端接口测试：在微信开发者工具“项目详情”中配置本地后端 API 域名（如 http://localhost:3000），确保接口可访问。
     - 启动后端服务（NestJS），确认接口可用。
     - 在前端请求中使用本地 API 地址，调试真实数据流和业务逻辑。
     - 可结合 Postman/Swagger UI 验证接口数据格式，确保前后端联调顺畅。
  3. 切换 mock 数据和真实接口时，可通过环境变量或配置文件控制，便于开发和测试。

#### 后端测试步骤
- 在 Linux 下启动后端服务（NestJS 项目，确保 API 可用）
  ```bash
  cd /home/liyong/gbb/server/baby-photo-backend
  npm run start:dev
  # 或者
  nest start
  ```
- 使用 Postman 或 Swagger UI (`http://localhost:3000/api/docs`) 测试各 API（如 /packages, /orders, /payments, /search 等）
  - 按照接口文档逐一验证核心业务接口，包括查找、预约、支付等
  - 测试不同参数组合和边界条件，确保接口健壮性
  - 检查分页、排序、模糊查询等高级功能
- 检查接口响应、数据格式、权限校验
  - 验证返回数据结构与前端需求一致
  - 检查错误码和异常处理是否合理
  - 测试带 token 的接口，确保权限控制有效
  - 对敏感接口进行安全性测试（如 SQL 注入、参数校验）

- 建议编写自动化测试用例（如 Jest），覆盖主要业务流程和查找功能
- 如有缓存（Redis），测试热点数据的缓存命中和失效逻辑

### 4. 性能与体验优化
- 页面分包加载，减少首屏体积
  - 在 `app.json` 中合理配置分包（subPackages），将管理后台、统计等非核心页面分包，提升首页加载速度。
  - 示例：
    ```json
    {
      "subPackages": [
        {
          "root": "pages/admin",
          "pages": ["dashboard/index", "search/index"]
        }
      ]
    }
    ```
- 图片懒加载，提升列表性能
  - 使用微信小程序的 `lazy-load` 属性或 vant-weapp 的 `<van-image lazy-load />` 组件实现图片懒加载。
  - 示例：
    ```xml
    <van-image src="{{item.coverUrl}}" lazy-load width="100px" height="100px" />
    ```
- 本地缓存用户信息和订单列表
  - 使用 `wx.setStorageSync` 和 `wx.getStorageSync` 缓存用户信息、订单列表等高频数据，减少重复请求。
  - 示例：
    ```javascript
    wx.setStorageSync('userInfo', userInfo);
    const cachedOrders = wx.getStorageSync('orders');
    ```
- 统一错误处理与提示
  - 在 `utils/api.js` 封装统一的错误处理逻辑，所有 API 请求失败时弹出友好提示。
  - 示例：
    ```javascript
    // utils/api.js
    function request(options) {
      return new Promise((resolve, reject) => {
        wx.request({
          ...options,
          success: res => {
            if (res.statusCode === 200) {
              resolve(res.data);
            } else {
              wx.showToast({ title: res.data.message || '请求失败', icon: 'none' });
              reject(res);
            }
          },
          fail: err => {
            wx.showToast({ title: '网络错误', icon: 'none' });
            reject(err);
          }
        });
      });
    }
    ```

### 5. 部署与上线
- 完善 appid、项目配置
  - 在 `project.config.json` 中填写正确的 `appid`，检查所有页面路径和分包配置无误。
  - 配置合法的 request 域名，确保所有后端 API 域名已在微信公众平台后台配置（如 api.example.com）。
  - 检查 `app.json` 的页面路径、分包配置、usingComponents 配置是否正确，避免漏掉新页面或组件。
  - 在微信公众平台后台配置服务器域名（request、uploadFile、downloadFile等），并在开发者工具“项目详情”中同步最新配置。
- 提交微信小程序审核，完成上线流程
  - 在微信开发者工具中进行代码检查、真机测试，确保无报错和异常，所有功能流程（预约、支付、查找等）均可正常使用。
  - 按照微信小程序审核要求填写应用描述、上传相关资质（如营业执照、拍摄资质等）。
  - 检查隐私政策、用户协议等合规性内容，确保审核顺利通过。
  - 提交审核，等待官方审核通过后发布上线，建议上线后再次全流程自测，确保生产环境无遗漏。
  - 后续如有新功能或Bug修复，按上述流程迭代发布新版。

---

## 三、开发建议

- 前端建议使用 Copilot 辅助编写业务逻辑和组件代码
- 后端建议接口文档同步维护，便于前后端联调
- 测试阶段建议用真实设备和模拟数据双重验证
- 关键流程（如支付、预约）需重点测试异常和边界情况

---

如需具体页面/组件代码示例，可进一步指定需求。
